// This run the full benchmarks twice a day, using the configurable run with specific settings.

pipeline {
    agent any

    triggers {
        cron 'H 6,19 * * *'
    }

    parameters {
        string(name: 'RUBY_VERSION', defaultValue: 'master', description: 'what revision of Ruby to build')
        string(name: 'YJIT_METRICS_VERSION', defaultValue: 'main', description: 'what revision of yjit-metrics to build with')
        string(name: 'YJIT_BENCH_VERSION', defaultValue: 'main', description: 'what revision of yjit-bench to build with')
        // For now, no yjit_extra_bench for optional benchmarks

        booleanParam(name: 'DO_FULL_REBUILD', defaultValue: true, description: 'whether to remove all appropriate Ruby and gem directories to ensure a clean rebuild (note: slow)')

        string(name: 'SLACK_FAILURE_NOTIFY', defaultValue: '#yjit-benchmark-ci', description: 'What Slack channel(s) and Member ID(s) to notify in case of failure, comma-delimited')

        // The benchmark timestamp can't be input manually, so it's not a parameter here
    }

    environment {
        SLACK_OAUTH_TOKEN = credentials('684cd699-feae-4ef1-8483-e71440a73fcd')
    }

    stages {
        stage('schedule parameterized benchmarking run') {
            steps {
                build job: 'benchmark_configurable_run',
                  parameters: [
                    string(name: 'RUBY_VERSION', value: params.RUBY_VERSION),
                    string(name: 'YJIT_METRICS_VERSION', value: params.YJIT_METRICS_VERSION),
                    string(name: 'YJIT_BENCH_VERSION', value: params.YJIT_BENCH_VERSION),
                    string(name: 'BENCH_TYPE', value: 'default'),
                    string(name: 'DATA_DIR', value: 'continuous_reporting/data'),
                    booleanParam(name: 'DO_FULL_REBUILD', value: params.DO_FULL_REBUILD)
                ]
            }
        }
    }

    post {
        failure {
            sh "bash -l -c 'chruby 3.0.2 && bundle'"
            sh "bash -l -c 'chruby 3.0.2 && ruby continuous_reporting/slack_build_notifier.rb --template build_status --channels \"${params.SLACK_FAILURE_NOTIFY}\" --properties \"status=fail\" \"Full benchmark run failed!\"'"
        }
    }

}
